# Portrait Generation System

Player portrait generation using composited face, hair, and facial hair assets with demographic-aware randomization.

## Overview

Portraits are generated by layering:
1. **Face** - 8 skin tones × 8 face widths (64 variants)
2. **Hair** - 64 styles × 12 colors (768 pre-tinted variants)
3. **Facial Hair** - 64 styles × 12 colors (768 pre-tinted variants)

Generation takes ~10ms per portrait (~100 portraits/sec).

## Storage

### Portrait Files

Portraits are stored per-league:
```
huddle/data/leagues/{league_id}/portraits/{player_id}.png
```

Deleting a league cleans up all its portraits.

### Player Model Fields

Portrait appearance attributes are persisted on the Player model for reproducibility:

```python
# Portrait appearance (set once at creation, persists)
portrait_seed: Optional[int] = None        # For reproducible generation
skin_tone: Optional[int] = None            # 0-7 (0=lightest, 7=darkest)
face_width: Optional[int] = None           # 0-7 (0=narrowest, 7=widest)
hair_style: Optional[tuple[int, int]] = None        # (row, col) or None for bald
facial_hair_style: Optional[tuple[int, int]] = None # (row, col) or None for clean shaven
hair_color: Optional[str] = None           # Current hair color (can change with age)
portrait_url: Optional[str] = None         # Generated portrait URL
```

These fields enable:
- **Reproducible regeneration**: Same seed + attributes = same portrait
- **Aging updates**: Change only `hair_color` to gray variants
- **Text descriptions**: Generate prose from stored attributes via `/describe`
- **Frontend display**: Direct access to style names without API call

## API Endpoints

Base: `/api/v1/portraits`

### Generate Portrait

```http
POST /api/v1/portraits/generate
Content-Type: application/json

{
  "league_id": "uuid",
  "player_id": "uuid",
  "position": "QB",           // Optional - affects skin tone distribution
  "age": 28,                  // Optional - affects gray hair chance
  "skin_tone": null,          // Optional (0-7) - null = random by position
  "face_width": null,         // Optional (0-7) - null = random
  "hair_style": [3, 5],       // Optional [row, col] - null = random
  "hair_color": "blonde",     // Optional - null = random by skin tone
  "facial_style": [1, 2],     // Optional [row, col] - null = random
  "facial_color": null,       // Optional - defaults to hair_color
  "no_hair": false,           // Set true for bald
  "no_facial_hair": false,    // Set true for clean shaven
  "seed": 12345               // Optional - for reproducible generation
}
```

**Response:**
```json
{
  "league_id": "uuid",
  "player_id": "uuid",
  "portrait_url": "/api/v1/portraits/{league_id}/{player_id}",
  "status": "ready",
  "attributes": {
    "skin_tone": 2,
    "face_width": 4,
    "hair_style": [3, 5],
    "hair_style_name": "Short Messy",
    "hair_color": "blonde",
    "facial_style": [1, 2],
    "facial_style_name": "Long Sideburns",
    "facial_color": "blonde"
  }
}
```

### Get Portrait Image

```http
GET /api/v1/portraits/{league_id}/{player_id}
```

Returns PNG image. Falls back to placeholder if not generated.

### Check Status

```http
GET /api/v1/portraits/status/{league_id}/{player_id}
```

**Response:**
```json
{
  "league_id": "uuid",
  "player_id": "uuid",
  "status": "ready",  // pending | ready | failed
  "portrait_url": "/api/v1/portraits/{league_id}/{player_id}"
}
```

### Regenerate Portrait

```http
POST /api/v1/portraits/regenerate/{league_id}/{player_id}?age=35
```

Regenerates with new parameters. Keeps skin_tone and face_width, re-rolls hair.
Use for aging updates or style changes.

### Delete Portrait

```http
DELETE /api/v1/portraits/{league_id}/{player_id}
```

### Delete All League Portraits

```http
DELETE /api/v1/portraits/{league_id}
```

Use when deleting a league.

### Get Available Options

```http
GET /api/v1/portraits/options
```

**Response:**
```json
{
  "skin_tones": [0, 1, 2, 3, 4, 5, 6, 7],
  "face_widths": [0, 1, 2, 3, 4, 5, 6, 7],
  "hair_colors": ["black", "dark_brown", "brown", ...],
  "hair_styles": [
    {"id": [0, 0], "name": "Buzz Cut", "description": "Very short, close-cropped hair"},
    ...
  ],
  "facial_styles": [
    {"id": [0, 0], "name": "Full Beard", "description": "Thick, bushy full beard"},
    ...
  ]
}
```

### Get Player Description

Generate a human-readable prose description of a player's appearance from their portrait attributes. Useful for accessibility, scout reports, or narrative content.

```http
POST /api/v1/portraits/describe
Content-Type: application/json

{
  "skin_tone": 1,
  "face_width": 1,
  "hair_style": [0, 1],
  "hair_color": "blonde",
  "facial_style": [0, 0],
  "facial_color": "blonde"
}
```

**Response:**
```json
{
  "description": "A man with a fair complexion and a lean face shape, with light eyes and subtle, even features. He has blonde Crew Cut hair. He has a Full Beard."
}
```

**Examples:**

| Attributes | Description |
|------------|-------------|
| skin_tone=6, face_width=5, hair_style=[1,5], hair_color=black | "A man with a dark complexion and a full face, featuring brown eyes and a substantial build. He has black Short Afro hair." |
| skin_tone=4, face_width=3, hair_style=null, facial_style=[0,2], facial_color=dark_brown | "A man with a medium-brown complexion and a well-structured face, featuring brown eyes and a composed look. He is bald. He has a dark brown Circle Beard." |
| skin_tone=2, face_width=4, hair_style=[3,7], hair_color=auburn, facial_style=[2,7] | "A man with a light complexion and a medium-full face, featuring hazel eyes and a strong jaw. He has auburn 360 Waves hair. He has a Van Dyke." |

The description is assembled from three catalogues:
- **Faces**: Full prose description based on skin tone + face width
- **Hair**: Style name from catalogue + color
- **Facial Hair**: Style name from catalogue (skipped if "Clean Shaven")

### Batch Generate (Background)

```http
POST /api/v1/portraits/batch/generate
Content-Type: application/json

{
  "league_id": "uuid",
  "players": [
    {"player_id": "uuid", "position": "QB", "age": 28, "priority": 100},
    {"player_id": "uuid", "position": "RB", "age": 24, "priority": 0}
  ]
}
```

**Response:**
```json
{
  "league_id": "uuid",
  "queued_count": 1696,
  "status": "processing",
  "message": "Queued 1696 portraits for generation"
}
```

Priority determines generation order (higher = first). Use `priority: 100` for the user's team.

### Batch Status

```http
GET /api/v1/portraits/batch/status/{league_id}
```

**Response:**
```json
{
  "league_id": "uuid",
  "total": 1696,
  "completed": 847,
  "failed": 0,
  "pending": 849,
  "status": "processing"
}
```

## Demographics

### Skin Tone Scale

| Tone | Description | Hair Color Tendency |
|------|-------------|---------------------|
| 0 | Lightest (Scandinavian) | 50% blonde, 10% red |
| 1 | Light | 48% blonde, 7% red |
| 2 | Light | 40% blonde |
| 3 | Medium (transition) | 70% black |
| 4-7 | Dark | 75-82% black |

### Position Demographics

Skin tone distribution based on NFL demographics:

| Position | % Dark Tones (3-7) | % Light Tones (0-2) |
|----------|-------------------|---------------------|
| RB | 85% | 15% |
| WR | 80% | 20% |
| CB | 75% | 25% |
| QB | 30% | 70% |
| OL | 40% | 60% |
| K/P | 5% | 95% |

### Age Effects

| Age | Bald Chance | Gray Hair Chance |
|-----|-------------|------------------|
| <35 | 5% | 2-10% |
| 35-39 | 15% | 25% |
| 40+ | 25% | 50%+ |

## Hair Colors

12 available colors:

**Natural:**
- `black` - Most common worldwide
- `dark_brown` - Common
- `brown` - Common
- `light_brown` - Less common
- `auburn` - Reddish-brown, rare
- `red` - Rarest natural (1-2%)
- `blonde` - Rare (2-3%)

**Age-related:**
- `gray` - Salt and pepper
- `silver` - Lighter gray
- `white` - Full white/gray

**Styled:**
- `bleach_blonde` - Dyed bright blonde
- `platinum` - Near-white blonde

## Hair Styles

64 styles organized in 8×8 grid. Notable styles:

| Type | Examples |
|------|----------|
| Short | Buzz Cut, Crew Cut, Caesar, Ivy League |
| Textured | 360 Waves, Short Afro, Full Afro, Natural Coils |
| Braided | Cornrows, Cornrows Fade, Cornrows Parted |
| Dreads | Medium Dreads, Long Dreads, Shoulder Dreads |
| Other | Pompadour, Quiff, Top Knot, Mullet |

## Facial Hair Styles

64 styles including:

| Type | Examples |
|------|----------|
| Full Beards | Garibaldi, Bandholz, Ducktail, Verdi |
| Goatees | Circle Beard, Van Dyke, Balbo, Anchor |
| Mustaches | Chevron, Handlebar, Horseshoe, Fu Manchu |
| Clean Shaven | 5 empty slots (auto-excluded) |

## Exclusions

Some style combinations are banned:

**Hair banned for all faces:**
- (6, 7) - Wavy Mullet

**Hair banned for widest face (width 7):**
- (4, 4-7), (5, 1), (5, 6)

**Facial hair banned for widest face:**
- (1, 4), (3, 5)

## Integration

### Automatic on Franchise Creation

When a franchise is created via `POST /api/v1/management/franchise`, portrait generation is automatically triggered in the background for all players in the league:

- User's team is prioritized (`priority: 100`)
- Other teams, free agents, and draft prospects get `priority: 0`
- Portraits "develop" as the queue processes (~17 seconds for full league)
- Frontend can poll `/api/v1/portraits/batch/status/{league_id}` for progress

No manual integration needed - portraits generate automatically.

### On Player Creation (Manual)

```python
# Generate portrait when creating a player
response = await client.post("/api/v1/portraits/generate", json={
    "league_id": league.id,
    "player_id": player.id,
    "position": player.position,
    "age": player.age,
})
```

### On Aging/Season Advance

```python
# Regenerate with new age for gray hair chance
await client.post(
    f"/api/v1/portraits/regenerate/{league_id}/{player_id}",
    params={"age": player.age}
)
```

### In Frontend

```tsx
<img
  src={`/api/v1/portraits/${leagueId}/${playerId}`}
  alt={player.name}
  onError={(e) => e.target.src = '/placeholder.png'}
/>
```

### On League Deletion

```python
# Clean up all portraits
await client.delete(f"/api/v1/portraits/{league_id}")
```

## Asset Pipeline

Assets are managed in `sprite-pipeline/`:

```
sprite-pipeline/
├── output/
│   ├── sliced/
│   │   ├── faces/           # face_skin{0-7}_width{0-7}.png
│   │   ├── hair_dark/       # Grayscale hair templates
│   │   └── facial_hair/     # Grayscale facial hair templates
│   ├── tinted/
│   │   ├── hair/{color}/    # Pre-tinted hair (768 files)
│   │   └── facial/{color}/  # Pre-tinted facial hair (768 files)
│   └── portraits/
│       └── placeholder.png  # Fallback silhouette
├── generator/
│   └── portrait.py          # Portrait generation logic
├── config/
│   ├── exclusions.py        # Banned style combinations
│   └── demographics.py      # Hair/skin tone distributions
└── scripts/
    ├── pretint.py           # Generate all color variants
    └── create_placeholder.py
```

### Rebuilding Assets

If hair colors need adjustment:

```bash
cd sprite-pipeline
source venv/bin/activate

# Regenerate all tinted variants
python scripts/pretint.py

# Regenerate placeholder
python scripts/create_placeholder.py
```

## Performance

| Operation | Time |
|-----------|------|
| Single portrait | ~10ms |
| 100 portraits | ~1 second |
| Full league (1,696 players) | ~17 seconds |

Pre-tinting eliminates runtime color processing - generation is just loading PNGs and compositing.
